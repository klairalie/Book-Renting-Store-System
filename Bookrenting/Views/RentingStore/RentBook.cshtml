@model BookRenting.Models.RentedBook

@{
    ViewData["Title"] = "Rent Book";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}

<h2 class="text-2xl font-semibold mb-4 text-gray-800">Rent This Book</h2>

<form asp-action="RentBookSubmit" method="post" enctype="multipart/form-data" class="bg-white p-5 rounded shadow-md max-w-2xl mx-auto space-y-4" id="rentForm">
    @Html.AntiForgeryToken()
    
    <!-- HIDDEN INPUTS TO SYNC DATA -->
    <input type="hidden" asp-for="BookType" id="hiddenBookType" />
    <input type="hidden" asp-for="ReturnDate" id="hiddenReturnDate" />
    <input type="hidden" asp-for="PaymentTotal" id="hiddenPaymentTotal" />
    <input type="hidden" asp-for="ReferenceNumber" id="hiddenReferenceNumber" />
    <input type="hidden" name="AmountPaid" id="hiddenAmountPaid" />

    <!-- USER INFO -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium">Full Name</label>
            <input asp-for="FullName" class="w-full border rounded p-2.5 text-sm" readonly required />
        </div>
        <div>
            <label class="block text-sm font-medium">Email</label>
            <input asp-for="Email" class="w-full border rounded p-2.5 text-sm" readonly required />
        </div>
        <div>
            <label class="block text-sm font-medium">Contact Number</label>
            <input asp-for="ContactNumber" class="w-full border rounded p-2.5 text-sm" readonly required/>
        </div>
        <div>
            <label class="block text-sm font-medium">Address</label>
            <input asp-for="Address" class="w-full border rounded p-2.5 text-sm" readonly required/>
        </div>
    </div>

    <!-- BOOK INFO -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium">Book Title</label>
            <input asp-for="BookTitle" class="w-full border rounded p-2.5 text-sm" readonly />
        </div>
        <div>
            <label class="block text-sm font-medium">Author</label>
            <input asp-for="Author" class="w-full border rounded p-2.5 text-sm" readonly />
        </div>
      <div>
    <label class="block text-sm font-medium">Book Type</label>
    <input asp-for="BookType"
           id="bookTypeValue"
           class="w-full border rounded p-2.5 text-sm"
           readonly />
</div>

        <div>
            <label class="block text-sm font-medium">Book Price</label>
            <input asp-for="BookPrice" id="bookPriceField" class="w-full border rounded p-2.5 text-sm" readonly />
        </div>
    </div>

    <!-- RENT INFO -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium">Borrow Date</label>
            <input asp-for="BorrowDate" type="date" id="BorrowDate" class="w-full border border-red-500 rounded p-2.5 text-sm" required />
        </div>

       <!-- Return Date for ALL Books -->
<div id="returnDateContainer">
    <label class="block text-sm font-medium">Return Date</label>
    <input asp-for="ReturnDate" id="returnDate" type="date" class="w-full border border-red-500 rounded p-2.5 text-sm"/>
    <p class="text-xs text-gray-500">
        Note: For digital books, total payment is Book Price + 20 PHP per day. For physical books, please return by this date.
    </p>
</div>


        <div>
            <label class="block text-sm font-medium">Borrow Type</label>
            <select asp-for="BorrowType" id="borrowType" class="w-full border border-red-500 rounded p-2.5 text-sm" required>
                <option value="">Select Type</option>
                <option value="walkin">Walk-in</option>
                <option value="ship">Ship</option>
                <option value="softcopy">Soft-Copy</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium">Deposit</label>
            <input asp-for="Deposit" id="depositField" class="w-full border rounded p-2.5 text-sm" readonly />
        </div>
        <div>
            <label class="block text-sm font-medium">Shipping Fee</label>
            <input asp-for="ShippingFee" id="shipFeeField" class="w-full border rounded p-2.5 text-sm" readonly />
        </div>
        <div>
            <label class="block text-sm font-medium">Total Payment</label>
            <input asp-for="PaymentTotal" id="totalPaymentField" class="w-full border rounded p-2.5 text-sm bg-gray-100" readonly />
        </div>

        <div>
    <label class="block text-sm font-medium">Late Fee</label>
    <input type="text" id="lateFeeField" class="w-full border rounded p-2.5 text-sm bg-gray-100" readonly />
</div>

        <div>
            <label class="block text-sm font-medium">Payment Mode</label>
            <select asp-for="PaymentMode" id="paymentMode" class="w-full border border-red-500 rounded p-2.5 text-sm" required>
                <option value="">Select....</option>
                <option value="cash">Cash</option>
                <option value="gcash">GCash</option>
            </select>
        </div>
        <!-- GCash Hidden Inputs -->
        <input type="hidden" asp-for="ReferenceNumber" id="referenceNumberHidden" />
        <input type="hidden" name="AmountPaid" id="hiddenAmountPaid" />
        <input type="hidden" name="BorrowType" id="hiddenBorrowType" />
        <input type="hidden" name="LateFee" id="hiddenLateFee" />


    </div>

    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full text-sm" id="submitBtn">
        Submit Rent Request
    </button>

    <!-- GCash Modal INSIDE FORM -->
    <div id="gcashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-5 rounded shadow-md w-96 relative">
            <button id="closeModal" class="absolute top-2 right-2 text-gray-500">&times;</button>

            <h3 class="text-lg font-semibold mb-2">GCash Payment</h3>

            <div class="mb-4 text-center">
                <img src="/images/gcash-qr.png" alt="GCash QR Code" class="mx-auto w-48 h-48"/>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium">Upload Receipt</label>
                <input type="file" id="receiptInput" accept="image/*" class="w-full"/>
                <img id="receiptPreview" class="mt-2 w-full h-40 object-contain hidden"/>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium">Reference Number</label>
                <input type="text" id="referenceNumber" class="w-full border rounded p-2.5" readonly/>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium">Amount Paid</label>
                <input type="number" step="0.01" id="amountPaid" class="w-full border rounded p-2.5" readonly/>
            </div>

            <button id="confirmPayment" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">
                Complete Payment
            </button>
        </div>
    </div>
</form>

<!-- Add SweetAlert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<script>
/* ============================================================
   PAGE LOAD – APPLY DIGITAL / PHYSICAL RULES
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
    const bookType = document.getElementById("bookTypeValue").value.toLowerCase();
    const borrowType = document.getElementById("borrowType");

    // Show return date container for all types
    document.getElementById("returnDateContainer").classList.remove("hidden");

    if (bookType === "digital") {
        borrowType.value = "softcopy";
        document.getElementById("hiddenBorrowType").value = "softcopy";
        borrowType.disabled = true;
        document.getElementById("depositField").value = 0;
        document.getElementById("shipFeeField").value = 0;

        // Restrict cash payment
        const cashOption = document.querySelector('#paymentMode option[value="cash"]');
        if (cashOption) cashOption.remove();
    } else { // Physical books
        borrowType.disabled = false;
        document.getElementById("depositField").value = 500;
        document.getElementById("shipFeeField").value = 100;
    }

    updatePayment();
});

/* ============================================================
   UPDATE PAYMENT WITH UPDATED LATE FEE LOGIC
============================================================ */
function updatePayment() {
    let bookPrice = parseFloat(document.getElementById("bookPriceField").value) || 0;
    let deposit = parseFloat(document.getElementById("depositField").value) || 0;
    let shipping = parseFloat(document.getElementById("shipFeeField").value) || 0;

    let total = deposit + shipping + bookPrice;
    let lateFee = 0;

    const bookType = document.getElementById("bookTypeValue").value.toLowerCase();
    const borrowDateInput = document.getElementById("BorrowDate").value;
    const returnDateInput = document.getElementById("returnDate").value;

    if (borrowDateInput && returnDateInput) {

        const borrowDate = new Date(borrowDateInput);
        const returnDate = new Date(returnDateInput);
        const today = new Date();

        /* ================================================
           DIGITAL BOOK PRICE = Book price + 20/day
        ================================================= */
        if (bookType === "digital") {
            if (returnDate > borrowDate) {
                const diffDays = Math.ceil((returnDate - borrowDate) / 86400000);
                total = bookPrice + (diffDays * 20);
            }
        }

        /* ================================================
           LATE FEE RULES (NEW FIXED VERSION)
           • NOT added to total
           • Starts AFTER 5 PM on return date
           • 20 pesos per day
        ================================================= */
        if (today.toDateString() === returnDate.toDateString()) {
            // Return date is today
            if (today.getHours() >= 17) {
                lateFee = 20;
            } else {
                lateFee = 0;
            }
        } 
        else if (today > returnDate) {
            // After return date — count days
            const lateDays = Math.ceil((today - returnDate) / 86400000);
            lateFee = lateDays * 20;
        } 
        else {
            lateFee = 0;
        }
    }

    // SHOW LATE FEE (display only)
    if (document.getElementById("lateFeeField")) {
        document.getElementById("lateFeeField").value = lateFee.toFixed(2);
    }

    // UPDATE **VISIBLE TOTAL WITHOUT LATE FEE**
    document.getElementById("totalPaymentField").value = total.toFixed(2);

    // UPDATE HIDDEN FIELD FOR BACKEND (total ONLY)
    document.getElementById("hiddenPaymentTotal").value = total.toFixed(2);

    // UPDATE HIDDEN FIELD FOR LATE FEE
    const lateFeeHidden = document.getElementById("hiddenLateFee");
    if (lateFeeHidden) {
        lateFeeHidden.value = lateFee.toFixed(2);
    }
}

/* ============================================================
   BORROW TYPE LOGIC
============================================================ */
document.getElementById("borrowType").addEventListener("change", function () {
    const bookType = document.getElementById("bookTypeValue").value.toLowerCase();
    if (bookType === "digital") return;
    let type = this.value;
    let depositField = document.getElementById("depositField");
    let shippingField = document.getElementById("shipFeeField");

    if (type === "ship") {
        depositField.value = 500;
        shippingField.value = 100;
    } else if (type === "walkin") {
        depositField.value = 150;
        shippingField.value = 0;
    } else {
        depositField.value = "";
        shippingField.value = "";
    }
    updatePayment();
});

/* ============================================================
   PREVENT SOFT COPY WHEN BOOK TYPE = PHYSICAL
============================================================ */
document.getElementById("borrowType").addEventListener("change", function () {
    const bookType = document.getElementById("bookTypeValue").value.toLowerCase();

    if (bookType === "physical" && this.value === "softcopy") {
        Swal.fire({
            icon: "error",
            title: "Not Allowed",
            text: "Physical books are not allowed for softcopy.",
            confirmButtonColor: "#3085d6"
        });

        this.value = "";
        document.getElementById("hiddenBorrowType").value = "";
        return;
    }

    document.getElementById("hiddenBorrowType").value = this.value;
});

/* ============================================================
   RECALCULATE WHEN DATES CHANGE
============================================================ */
document.getElementById("BorrowDate").addEventListener("change", updatePayment);
document.getElementById("returnDate")?.addEventListener("change", updatePayment);

/* ============================================================
   GCASH MODAL LOGIC
============================================================ */
const paymentMode = document.getElementById("paymentMode");
const gcashModal = document.getElementById("gcashModal");
const closeModal = document.getElementById("closeModal");
const receiptInput = document.getElementById("receiptInput");
const receiptPreview = document.getElementById("receiptPreview");
const referenceNumber = document.getElementById("referenceNumber");
const amountPaid = document.getElementById("amountPaid");
const confirmPayment = document.getElementById("confirmPayment");

paymentMode.addEventListener("change", function() {
    if(this.value === "gcash") {
        updatePayment(); // ensure total is correct
        gcashModal.classList.remove("hidden");
    } else {
        gcashModal.classList.add("hidden");
    }
});
closeModal.addEventListener("click", () => gcashModal.classList.add("hidden"));

// ============================================================
// PREVENT CASH PAYMENT WHEN BORROW TYPE = SHIP
// ============================================================
document.getElementById("borrowType").addEventListener("change", function () {
    const paymentMode = document.getElementById("paymentMode");

    if (this.value === "ship") {
        // Remove cash option if exists
        const cashOption = paymentMode.querySelector('option[value="cash"]');
        if (cashOption) cashOption.remove();

        Swal.fire({
            icon: "info",
            title: "Notice",
            text: "Cash payment is NOT allowed for shipping. Please use GCash.",
            confirmButtonColor: "#3085d6"
        });

        // Auto-select GCash
        paymentMode.value = "gcash";
    } 
    else {
        // If NOT shipping and cash option is missing → restore it
        if (!paymentMode.querySelector('option[value="cash"]')) {
            const opt = document.createElement("option");
            opt.value = "cash";
            opt.textContent = "Cash";
            paymentMode.insertBefore(opt, paymentMode.firstChild.nextSibling); 
        }
    }
}) ;

/* ============================================================
   RECEIPT OCR — AUTO-READ REFERENCE # AND AMOUNT PAID
============================================================ */
receiptInput.addEventListener("change", function() {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        receiptPreview.src = e.target.result;
        receiptPreview.classList.remove("hidden");

        Tesseract.recognize(e.target.result, "eng")
        .then(({ data: { text } }) => {

            const refMatch = text.match(/Ref(?:erence)?\s*No\.?\s*[:#]?\s*([\d\s]{8,})/i);
            referenceNumber.value = refMatch ? refMatch[1].replace(/\s+/g, '') : "";

            const amountMatch =
                text.match(/Total\s*Amount\s*Sent\s*[:\-]?\s*₱?\s*([\d,]+\.\d{1,2})/i)
                || text.match(/Amount\s*[:\-]?\s*₱?\s*([\d,]+\.\d{1,2})/i)
                || text.match(/₱\s*([\d,]+\.\d{1,2})/);

            if (amountMatch) {
                let extracted = amountMatch[1].replace(/,/g, "");
                amountPaid.value = parseFloat(extracted).toFixed(2);
            }
        });
    };
    reader.readAsDataURL(file);
});

/* ============================================================
   CONFIRM PAYMENT
============================================================ */
confirmPayment.addEventListener("click", function(e) {
    e.preventDefault();
    const paid = parseFloat(amountPaid.value);
    const total = parseFloat(document.getElementById("totalPaymentField").value);

    if (paid !== total) {
        alert("Amount paid does not match total payment!");
        return;
    }

    document.getElementById("referenceNumberHidden").value = referenceNumber.value;
    document.getElementById("hiddenAmountPaid").value = paid;

    gcashModal.classList.add("hidden");
    alert("Payment validated! You may now submit your rent request.");
    this.disabled = true;
});

/* ============================================================
   SWEETALERT SUCCESS MESSAGE & FORM SUBMISSION
============================================================ */
document.getElementById("rentForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const submitBtn = document.getElementById("submitBtn");
    const form = this;

    // Sync hidden fields
    document.getElementById("hiddenBookType").value = document.getElementById("bookTypeValue").value;
    document.getElementById("hiddenReturnDate").value = document.getElementById("returnDate")?.value || "";
    document.getElementById("hiddenPaymentTotal").value = document.getElementById("totalPaymentField").value;
    document.getElementById("hiddenReferenceNumber").value = document.getElementById("referenceNumber").value;
    
    const amountPaidVal = parseFloat(document.getElementById("amountPaid").value) || 0;
    const totalPaymentVal = parseFloat(document.getElementById("totalPaymentField").value) || 0;
    document.getElementById("hiddenAmountPaid").value = amountPaidVal;

    document.getElementById("hiddenBorrowType").value = document.getElementById("borrowType").value;

    const paymentModeVal = document.getElementById("paymentMode").value;

    // ⚠️ VALIDATE PAYMENT ONLY FOR GCash
    if (paymentModeVal === "gcash") {
        if (amountPaidVal !== totalPaymentVal) {
            Swal.fire({
                icon: 'error',
                title: 'Payment Mismatch',
                text: 'The amount paid does not match the total payment. Please check your GCash payment before submitting.',
                confirmButtonColor: '#3085d6',
            });
            return; // stop submission
        }

        if (!document.getElementById("referenceNumber").value) {
            Swal.fire({
                icon: 'error',
                title: 'Incomplete Payment Details',
                text: 'Please provide the GCash reference number before submitting.',
                confirmButtonColor: '#3085d6',
            });
            return; // stop submission
        }
    } else {
        // Cash payments can leave AmountPaid as 0
        document.getElementById("hiddenAmountPaid").value = 0;
    }

    // Proceed with submission
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

    try {
        const formData = new FormData(form);
        const receiptFile = document.getElementById('receiptInput').files[0];
        if (receiptFile) formData.append('ReceiptFile', receiptFile);

        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            }
        });

        if (response.ok) {
            await Swal.fire({
                icon: 'success',
                title: 'Rent Request Submitted!',
                html: `<div class="text-center"><div class="mb-4">✅</div>
                       <p class="text-gray-600 mb-4">Your book rental request has been successfully submitted and is pending approval.</p></div>`,
                showCancelButton: true,
                confirmButtonText: 'Back to Dashboard',
                cancelButtonText: 'Stay on Page',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#6b7280',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '@Url.Action("Dashboard", "RentingStore")';
                } else {
                    form.reset();
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Rent Request';
                    updatePayment();
                }
            });
        } else {
            throw new Error('Submission failed');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Submission Failed',
            text: 'There was an error submitting your request. Please try again.',
            confirmButtonColor: '#3085d6',
        });
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Rent Request';
    }
});

</script>
